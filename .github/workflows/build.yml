name: build

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
    tags:
      - '*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      -
        name: Set TAG_NAME
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "##[set-env name=TAG_NAME;]${GITHUB_REF#refs/tags/}"
      -
        # https://github.com/actions/checkout
        name: Checkout
        uses: actions/checkout@v1
      -
        name: Set up Go
        uses: actions/setup-go@master
        with:
          go-version: 1.12.4
      -
        name: Build
        env:
          GO111MODULE: on
          GOPROXY: https://goproxy.io
          CGO_ENABLED: 1
        run: |
          go version
          for GOOS in darwin linux windows; do
            for GOARCH in 386 amd64; do
              export GOOS GOARCH
              if [[ "$GOOS" == "windows" ]]; then EXT=.exe else EXT= fi
              go build -v -s -w -X main.version=${TAG_NAME} -o firefox-history-merger-$GOOS-$GOARCH$EXT
            done
          done
